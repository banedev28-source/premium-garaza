generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  BUYER
}

enum UserStatus {
  PENDING
  ACTIVE
  DEACTIVATED
}

enum AuctionStatus {
  DRAFT
  LIVE
  ENDED
  CANCELLED
  ARCHIVED
}

enum Currency {
  RSD
  EUR
}

enum AuctionType {
  SEALED
  OPEN
  INDICATOR
  ANONYMOUS
}

enum NotificationType {
  INVITATION
  AUCTION_START
  AUCTION_END
  OUTBID
  AUCTION_WON
  AUCTION_LOST
  BUY_NOW
}

model User {
  id                String     @id @default(cuid())
  email             String     @unique
  name              String?
  passwordHash      String?
  role              Role       @default(BUYER)
  status            UserStatus @default(PENDING)
  language          String     @default("sr")
  invitedById       String?
  invitedBy         User?      @relation("InvitedBy", fields: [invitedById], references: [id])
  invitedUsers      User[]     @relation("InvitedBy")
  inviteToken       String?    @unique
  inviteTokenExpiry DateTime?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  bids              Bid[]
  notifications     Notification[]
  failedLoginAttempts Int        @default(0)
  lockedUntil       DateTime?
  createdAuctions   Auction[]   @relation("CreatedAuctions")
  wonAuctions       Auction[]   @relation("WonAuctions")
  createdVehicles   Vehicle[]
  auditLogs         AuditLog[]
}

model Vehicle {
  id             String   @id @default(cuid())
  name           String
  description    String?  @db.Text
  specifications Json?
  images         String[]
  createdById    String
  createdBy      User     @relation(fields: [createdById], references: [id])
  auction        Auction?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Auction {
  id               String        @id @default(cuid())
  vehicleId        String        @unique
  vehicle          Vehicle       @relation(fields: [vehicleId], references: [id])
  createdById      String
  createdBy        User          @relation("CreatedAuctions", fields: [createdById], references: [id])
  status           AuctionStatus @default(DRAFT)
  startTime        DateTime
  endTime          DateTime
  currency         Currency      @default(EUR)
  startingPrice    Decimal?      @db.Decimal(12, 2)
  reservePrice     Decimal?      @db.Decimal(12, 2)
  showReservePrice Boolean       @default(false)
  auctionType      AuctionType   @default(OPEN)
  showBidCount     Boolean       @default(true)
  buyNowEnabled    Boolean       @default(false)
  buyNowPrice      Decimal?      @db.Decimal(12, 2)
  winnerId         String?
  winner           User?         @relation("WonAuctions", fields: [winnerId], references: [id])
  finalPrice       Decimal?      @db.Decimal(12, 2)
  bids             Bid[]
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([status])
  @@index([startTime])
  @@index([endTime])
}

model Bid {
  id        String   @id @default(cuid())
  auctionId String
  auction   Auction  @relation(fields: [auctionId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  amount    Decimal  @db.Decimal(12, 2)
  isBuyNow  Boolean  @default(false)
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  @@index([auctionId, amount(sort: Desc)])
  @@index([auctionId, createdAt])
  @@index([userId])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id])
  type      NotificationType
  title     String
  message   String
  data      Json?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([userId, read])
  @@index([userId, createdAt(sort: Desc)])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  targetId  String?
  metadata  Json?
  ip        String?
  createdAt DateTime @default(now())

  @@index([action])
  @@index([userId])
  @@index([createdAt])
}
